{% comment %} sections/feature-tabs.liquid (flow layout, roomy padding, crisp image) {% endcomment %}
<section
  id="feature-tabs-{{ section.id }}"
  class="feature-tabs"
  style="--ft-pad-t: {{ section.settings.pad_top | default: 48 }}px; --ft-pad-b: {{ section.settings.pad_bottom | default: 48 }}px;"
>
  {% if section.settings.heading != blank %}
    <h2 class="ft-heading h1">{{ section.settings.heading }}</h2>
  {% endif %}

  <div class="ft-tablist-wrap">
    <div class="ft-tablist" role="tablist" aria-label="{{ section.settings.heading | escape }}">
      {%- for block in section.blocks -%}
        <h3 class="ft-tab-h">
          <button
            id="ft-tab-{{ block.id }}"
            class="ft-tab {% if forloop.first %}is-active{% endif %}"
            role="tab"
            aria-selected="{{ forloop.first }}"
            aria-controls="ft-panel-{{ block.id }}"
            tabindex="{% if forloop.first %}0{% else %}-1{% endif %}"
            data-panel="ft-panel-{{ block.id }}"
            {{ block.shopify_attributes }}
          >
            {{ block.settings.tab_title | escape }}
          </button>
        </h3>
      {%- endfor -%}
    </div>
    <div class="ft-rail"></div>
  </div>

  <div class="ft-panels">
    {%- for block in section.blocks -%}
      <div
        id="ft-panel-{{ block.id }}"
        class="ft-panel {% if forloop.first %}is-active{% endif %}"
        role="tabpanel"
        aria-labelledby="ft-tab-{{ block.id }}"
        tabindex="0"
      >
        <div class="ft-media">
          {% if block.settings.tab_image %}
            {{ block.settings.tab_image
              | image_url: width: 1200
              | image_tag:
                  alt: block.settings.tab_title,
                  widths: "320,420,480,540,720,960,1200",
                  sizes: "(max-width: 768px) 80vw, 40vw",
                  loading: "lazy"
            }}
          {% endif %}
        </div>
        <div class="ft-desc rte">
          {{ block.settings.tab_description }}
        </div>
      </div>
    {%- endfor -%}
  </div>
</section>

<style>
  /* Section padding
     - L/R: wider via % and capped; mobile stays comfy and responsive
     - T/B: controlled via schema (CSS vars)
  */
  #feature-tabs-{{ section.id }} {
    padding-top: var(--ft-pad-t);
    padding-bottom: var(--ft-pad-b);
    padding-left: clamp(20px, 12vw, 29rem);
    padding-right: clamp(20px, 12vw, 29rem);
    border-bottom: 1px solid var(--custom-dark);
    border-top: 1px solid var(--custom-dark);
    background: var(--custom-primary);
  }
  @media (max-width: 768px) {
    #feature-tabs-{{ section.id }} {
      padding-left: clamp(16px, 12vw, 8rem);
      padding-right: clamp(16px, 12vw, 8rem);
    }
  }

  /* Heading: always centered, margin reset + 6rem bottom */
  #feature-tabs-{{ section.id }} .ft-heading {
    text-align: center;
    margin: 0 0 6rem;
  }

  /* Tabs (flow) */
  #feature-tabs-{{ section.id }} .ft-tablist-wrap { margin-bottom: clamp(2rem, 6vw, 7rem); }
  #feature-tabs-{{ section.id }} .ft-tablist {
    display:flex; flex-wrap:wrap; justify-content:space-between; gap:20px;
  }
  #feature-tabs-{{ section.id }} .ft-tab-h { margin: 0; }
  #feature-tabs-{{ section.id }} .ft-tab {
    background:none; border:none; cursor:pointer; color:inherit; padding:6px 8px;
    opacity:.85; text-decoration:none; font:inherit; line-height:inherit;
  }
  #feature-tabs-{{ section.id }} .ft-tab.is-active { opacity:1; text-decoration: underline; text-underline-offset: 6px; }

  /* Divider under tabs */
  #feature-tabs-{{ section.id }} .ft-rail {
    margin-top: 8px;
    height:1px; width:100%; background: currentColor; opacity:.2;
  }

  /* Panels (flow) */
  #feature-tabs-{{ section.id }} .ft-panels { display:block; }
  #feature-tabs-{{ section.id }} .ft-panel { display:none; }
  #feature-tabs-{{ section.id }} .ft-panel.is-active { display:block; animation: ft-fade-up .28s ease both; }
  @keyframes ft-fade-up { from { opacity:0; transform: translateY(8px);} to { opacity:1; transform: translateY(0);} }

  /* Image: responsive, with min/max to avoid tiny or blurry display */
  #feature-tabs-{{ section.id }} .ft-media { display:flex; justify-content:center; }
  #feature-tabs-{{ section.id }} .ft-media img {
    inline-size: clamp(240px, 42vw, 520px); /* min 240px, scales to 42vw, max 520px */
    block-size: auto;
    display:block;
    margin: 0 auto 16px;
    width: 100%;
    max-width: 200px;
    border:1px solid var(--custom-dark);
    {% comment %} box-shadow: 1px 2px 5px rgba(0,0,0,0.1); {% endcomment %}
    border-radius: 50%;
    padding: 2rem;
    {% comment %} background: var(--custom-secondary); {% endcomment %}
  }
  @media (max-width: 768px) {
    #feature-tabs-{{ section.id }} .ft-media img { inline-size: clamp(200px, 80vw, 400px); }
  }

  #feature-tabs-{{ section.id }} .ft-desc { max-width: 760px; margin: 0 auto; text-align: center; }

  @media (prefers-reduced-motion: reduce) {
    #feature-tabs-{{ section.id }} .ft-panel.is-active { animation: none !important; }
  }
</style>

<script>
  (function() {
    const root = document.getElementById('feature-tabs-{{ section.id }}');
    if (!root) return;

    const tabs = Array.from(root.querySelectorAll('.ft-tab'));
    const panels = Array.from(root.querySelectorAll('.ft-panel'));

    function activate(idx) {
      tabs.forEach((t, i) => {
        const active = i === idx;
        t.classList.toggle('is-active', active);
        t.setAttribute('aria-selected', active);
        t.setAttribute('tabindex', active ? '0' : '-1');
      });
      panels.forEach((p, i) => p.classList.toggle('is-active', i === idx));
      tabs[idx].focus();
    }

    tabs.forEach((tab, i) => {
      tab.addEventListener('click', () => activate(i));
      tab.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight') { e.preventDefault(); activate((i + 1) % tabs.length); }
        if (e.key === 'ArrowLeft')  { e.preventDefault(); activate((i - 1 + tabs.length) % tabs.length); }
      });
    });
  })();
</script>

{% schema %}
{
  "name": "Feature Tabs (flow)",
  "tag": "section",
  "class": "feature-tabs-section",
  "settings": [
    { "type": "text", "id": "heading", "label": "Section heading", "default": "Quality Certified" },
    { "type": "range", "id": "pad_top", "min": 0, "max": 200, "step": 4, "unit": "px", "label": "Top padding", "default": 48 },
    { "type": "range", "id": "pad_bottom", "min": 0, "max": 200, "step": 4, "unit": "px", "label": "Bottom padding", "default": 48 }
  ],
  "blocks": [
    {
      "type": "tab",
      "name": "Feature Tab",
      "settings": [
        { "type": "text", "id": "tab_title", "label": "Tab title", "default": "Dermatest Approved" },
        { "type": "image_picker", "id": "tab_image", "label": "Center image (logo/badge)" },
        { "type": "richtext", "id": "tab_description", "label": "Description", "default": "<p>Feature details go here.</p>" }
      ]
    }
  ],
  "max_blocks": 6,
  "presets": [
    { "name": "Feature Tabs (flow)", "blocks": [{ "type": "tab" }, { "type": "tab" }, { "type": "tab" }, { "type": "tab" }] }
  ]
}
{% endschema %}
